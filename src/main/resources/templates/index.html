<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">

<head>

    <meta charset="UTF-8">
    <title>Барбершоп</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <style>
        body {
            background-color: powderblue;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

<blockquote class="blockquote text-center"><h1>Записи клиентов в барбершопе</h1></blockquote>

<div class="row">
    <div class="col-md-8 offset-md-4">
        <h4>Поиск записи по любому критерию:</h4>
        <form th:action="@{/}">
            <input type="text" name="keyword" id="keyword" size="70" th:value="${keyword}" required/>
            <input type="submit" class="btn btn-success btn-sm" value="Поиск"/>
            <input type="button" class="btn btn-warning btn-sm" value="Очистить" id="btnClear"
                   onclick="clearSearch()"/>
        </form>
    </div>
</div>

<h4>Сортировка</h4>
<a th:href="@{'/sorted/asc'}">Сортировать по дате записи (по возрастанию)</a> |
<a th:href="@{'/sorted/desc'}">Сортировать по дате записи (по убыванию)</a>

<table id="1" class="table table-striped table-hover">
    <thead>
    <tr>
        <th scope="col">ID записи</th>
        <th scope="col">ФИО клиента</th>
        <th scope="col">Дата записи</th>
        <th scope="col">Наименование услуги</th>
        <th scope="col">ФИО обслуживающего мастера</th>
        <th scope="col">Действия</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="client: ${listClients}">
        <th scope="row" class="text-black" th:text="${client.id}">ID записи отсутствует</th>
        <th scope="row" class="text-black" th:text="${client.clientName}">ФИО клиента отсутствует</th>
        <th scope="row" class="text-black" th:text="${client.date}">Дата записи отсутствует</th>
        <th scope="row" class="text-black" th:text="${client.service}">Наименование услуги отсутствует</th>
        <th scope="row" class="text-black" th:text="${client.master}">ФИО обслуживающего мастера отсутствует</th>
        <td>
            <a th:href="@{'/edit/'+${client.id}}"><button type="button" class="btn btn-info">Редактировать</button></a>
            <a th:href="@{'/delete/'+${client.id}}"><button type="button" class="btn btn-danger">Удалить</button></a>
        </td>
    </tr>
    </tbody>
</table>

<p class="text-black">
    <script type="text/javascript">
        function getRowsColumn() {
            let table = document.getElementById('1')
            let tBody = table.querySelector('tbody')
            const count = tBody.querySelectorAll('tr').length;
            document.write('Количество записей в таблице: ' + count)
        }
        getRowsColumn();

    </script>
</p>

<p class="text-black">
    <script type="text/javascript">

        function getAvgClientsPerDay() {
            let table = document.getElementById('1')
            let tBody = table.querySelector('tbody')
            const rows = tBody.querySelectorAll('tr')

            let clientsByDay = {};

            rows.forEach(row => {
                let date = row.cells[2].innerText;

                if (clientsByDay[date]) {
                    clientsByDay[date] += 1;
                } else {
                    clientsByDay[date] = 1;
                }
            });

            let totalDays = Object.keys(clientsByDay).length;
            let totalClients = Object.values(clientsByDay).reduce((a, b) => a + b, 0);

            let averageClients = totalClients / totalDays;

            document.write('Cреднее количество клиентов в день: ' + averageClients.toFixed(2))
        }
        getAvgClientsPerDay();

    </script>
</p>

<blockquote class="blockquote text-center">
    <h4>Гистограмма количества записей клиентов по дням</h4>
    <canvas id="registrationChart" style="width: 80%; height: 500px; margin:auto"></canvas>
</blockquote>

<script type="text/javascript">
    function getClientsData() {
        const table = document.getElementById('1');
        const rows = table.querySelectorAll('tbody tr');

        const registrationDates = {};

        rows.forEach(row => {
            const dateCell = row.cells[2].innerText;

            if (registrationDates[dateCell]) {
                registrationDates[dateCell] += 1;
            } else {
                registrationDates[dateCell] = 1;
            }
        });

        return registrationDates;
    }

    function renderChart() {
        const clientsData = getClientsData();
        const dates = Object.keys(clientsData);
        const counts = Object.values(clientsData);

        const ctx = document.getElementById('registrationChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Количество записей',
                    data: counts,
                    backgroundColor: 'rgba(255, 0, 100, 0.5)',
                    borderColor: 'rgba(0, 0, 0, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', renderChart);
</script>

<blockquote class="blockquote text-center">
    <a href="/new">
        <button type="button" class="btn btn-primary" data-togge="button" aria-pressed="false" autocomplete="off">
            Добавить запись
        </button>
    </a>
</blockquote>

<script type="text/javascript">
    function clearSearch() {
        window.location = "[[@{/}]]";
    }
</script>

</body>
</html>